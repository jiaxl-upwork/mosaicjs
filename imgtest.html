<!DOCTYPE html>
<html>
    <head>
        <style>
            
            
            #content {
                height: 1080px;
                width: 1080px;
                border: 1px solid gray;
                margin-left: auto;
                margin-right: auto;
            }
            
            #imgcontainer {
                position: absolute;
                width: inherit;
                height: inherit;
            }


            #container {
                position: absolute;
                width: inherit;
                height: inherit;
                border: 1px solid gray;
                margin-left: auto;
                margin-right: auto;
                
                display:flex;
                flex-direction:column;
                align-items:flex-start;
            }

            #bgimage {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }


            #uploadPics {
            
                width: 1200px;
                border: 1px solid gray;
                margin-left: auto;
                margin-right: auto;
            }

            div.row{
                display: flex;
                flex-direction:row;
                align-items:flex-start;
                width: 100%;
                min-height:0;
                flex:1 1 0;
            }
            div.cell{
                background-color: #fffffff2;
                height: 100%;
                flex: 1 1 0;
                position: relative;
            }

            div.cover{
                position: absolute;
                top: 0px;
                left: 0px;
            }


        </style>
    </head>
    <body>
        <div id="bg" style="height: 1600px; border:1px solid goldenrod">
            <div id="content">
                <div id="imgcontainer">
                    <img id="bgimage">
                </div>
                <div id="container">
                </div>
            </div>
            <div id="uploadPics">
                <input type="file" id="bginput">
                <input type="file" id="fginput">
            </div>
            <div class="selected" style="width: 200px; height: 200px; border: 1px solid red; margin-left:auto; margin-right: auto;">
                <img id="selectedPic" style="width: 200px; height: 200px;">
            </div>
        </div>
    </body>

    <script>
        var context;
        var pxlMatrix;
        var rowNum;
        var colNum;
        const pxlPerBlock = 2**4;
        var fgImgList = [];
        function initial(){
            
            let bgImg = document.getElementById("bginput");
            let fgImgs = document.getElementById("fginput");
            bgImg.addEventListener(
                "change", 
                (event) => {
                    var imgFile = event.target.files[0];
                    var imgUrl =  window.URL.createObjectURL(imgFile);
                    
                    let img = document.getElementById("bgimage");
                    img.src = imgUrl;
                    img.onload=(event) => {
                        const canvas = document.createElement('canvas');
                        context = canvas.getContext('2d');
                        const width = event.target.width;
                        const height = event.target.height;

                        canvas.width = width;
                        canvas.height = height;

                        context.drawImage(img, 0, 0, width, height);
                        initGrid(height, width, context);
                        
                    }
                },
                false
            );

            fgImgs.addEventListener(
                "change", 
                (event) => {
                    let fgFiles = event.target.files;
                    let fgUrl = window.URL.createObjectURL(fgFiles[0]);
                    // fgFiles.forEach(element => {
                    fgImgList[0] = fgUrl;
                    // });

                    setInterval(updateBgImg(rowNum, colNum), 20);
                },
                false
            );

            
        }

        function updateBgImg(r, c){
            var currRow = 0;
            var currCol = 0;
            return function(){
                let cellImgEle = document.getElementById(currRow + "-" + currCol);
                cellImgEle.src = fgImgList[0];
                cellImgEle.onmouseover = mouseOver;

                let cellCoverEle = cellImgEle.nextSibling;
                cellCoverEle.onmouseover = mouseOver;
                cellCoverEle.style.backgroundColor = pxlMatrix[currRow][currCol].toRGBString(true);

                if(currCol < c - 1){
                    currCol += 1;
                }else if(currCol == c - 1 && currRow < r - 1){
                    currCol = 0;
                    currRow += 1;
                }
            }
        }

        function mouseOver(event){
            let selectedShow = document.getElementById("selectedPic");
            let selectedEle = event.target.previousElementSibling;
            selectedShow.src = selectedEle.src;
            console.log(event.target);
        }

        function initGrid(h, w, ctx){
            let targetDiv = document.getElementById("container");
            let data = ctx.getImageData(0, 0, w, h);
            rowNum = Math.floor(h / pxlPerBlock);
            colNum = Math.floor(w / pxlPerBlock);
            let pxlRow = new Array(rowNum)
            for(let r = 0; r < rowNum; r++){
                let divRow = document.createElement("div");
                divRow.className = "row";
                pxlRow[r] = new Array(colNum)
                for(let c = 0; c < colNum; c++){
                    let cell = document.createElement("div");
                    cell.className = "cell";

                    let cover = document.createElement("div");
                    cover.className = "cover";
                    cover.style.height = pxlPerBlock + "px";
                    cover.style.width = pxlPerBlock + "px";
                    cell.appendChild(cover);

                    let cellImg = document.createElement("img");
                    cellImg.className = "cellImg";
                    cellImg.setAttribute("id", r + "-" + c);
                    cellImg.style.height = pxlPerBlock + "px";
                    cellImg.style.width = pxlPerBlock + "px";
                    cellImg.style.verticalAlign = "top";
                    cell.prepend(cellImg);
                    
                    divRow.appendChild(cell);
                    pxlRow[r][c] = getRGB(r, c, ctx);
                    cell.style.backgroundColor = pxlRow[r][c].toRGBString();
                }
                targetDiv.appendChild(divRow);
            }
            pxlMatrix = pxlRow;
        }

        function getRGB(r, c, ctx){
            let data;
            let rgb={
                r:0, 
                g:0, 
                b:0, 
                alph:0,
                toRGBString: function(transparancy){
                    if (!transparancy){
                        return "rgba(" + this.r + ", " + this.g + ", " + this.b  + ")"
                    }else{
                        return "rgba(" + this.r + ", " + this.g + ", " + this.b  + ", " + "0.8" + ")"
                    }
                    
                }
            }
            if((c + 1) * pxlPerBlock >= ctx.width || (r + 1) * pxlPerBlock >= ctx.height){
                data = context.getImageData(c * pxlPerBlock, r * pxlPerBlock, pxlPerBlock, pxlPerBlock);
            }else{
                data = context.getImageData(c * pxlPerBlock, r * pxlPerBlock, pxlPerBlock, pxlPerBlock);
            }

            let pxlCount = data.data.length
            for(let i = 0; i < pxlCount;){
                
                rgb.r += data.data[i];
                rgb.g += data.data[i+1];
                rgb.b += data.data[i+2];
                rgb.alph += data.data[i+3];
                i += 4
            }

            // ~~ used to floor values
            rgb.r = ~~(rgb.r/(pxlCount / 4));
            rgb.g = ~~(rgb.g/(pxlCount / 4));
            rgb.b = ~~(rgb.b/(pxlCount / 4));
            rgb.alph = ~~(rgb.alph/(pxlCount / 4));
            return rgb
        }
    
        initial();
        
    </script>
</html>